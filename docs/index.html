
<!--
  Copyright 2018 The Distill Template Authors

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!doctype html>

<head>
  <script src="lib/template.v2.js"></script>
  <script src="lib/d3.v7.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf8">

  <style>
    .flex-row {
      display: flex;
      flex-direction: column;
    }

    .flex-item {
      display: flex;
      flex-direction: row;
      gap: 5px;
    }

    .slider {
      cursor: pointer;
      margin: 0 20px;
    }

    .button {
      height: 34px;
      color: rgba(0, 0, 0, 0.6);
      border: none;
      background: rgba(158,158,158,.3);
      border-radius: 3px;
      padding: 5px;
      font-size: 12px;
      text-transform: uppercase;
      outline: none;
      transition: background 0.3s linear;
      cursor: pointer;
    }

    .button:hover {
      background: rgba(158,158,158,.5);
      color: rgba(0, 0, 0, 0.8);
    }

    .header {
      font-size: 12pt;
      font-weight: 400;
      text-transform: capitalize;
    }

    .header-medium {
      font-size: 12pt;
      font-weight: 400;
      text-transform: capitalize;
    }

    .header-small {
      font-size: 9pt;
      font-weight: 400;
    }
  </style>
</head>

<body>
  <!-- <distill-header></distill-header> -->
  <distill-header></distill-header>
  <d-front-matter id="top">
    <script id='distill-front-matter' type="text/json">{
    "title": "Echoes from the DataRealm",
    "description": "Although \" extremely useful for visualizing high-dimensional data, t-SNE plots can sometimes be mysterious or misleading.",
    "published": "Aug 17, 2023",
    "authors": [
      {
        "author":"Lalith Sharan",
        "authorURL":"",
        "affiliations": [{"name": "Heidelberg University Hospital", "url": "https://www.klinikum.uni-heidelberg.de/chirurgische-klinik-zentrum/herzchirurgie/forschung/ag-artificial-intelligence-in-cardiovascular-medicine"}]
      },
      {
        "author":"Georgii Kostiuchik",
        "authorURL":"",
        "affiliations": [{"name": "Heidelberg University Hospital", "url": "https://www.klinikum.uni-heidelberg.de/chirurgische-klinik-zentrum/herzchirurgie/forschung/ag-artificial-intelligence-in-cardiovascular-medicine"}]
       },
      {
        "author":"Sandy Engelhardt",
        "authorURL":"",
        "affiliations": [{"name": "Heidelberg University Hospital", "url": "https://www.klinikum.uni-heidelberg.de/chirurgische-klinik-zentrum/herzchirurgie/forschung/ag-artificial-intelligence-in-cardiovascular-medicine"}]
         }
    ],
    "katex": {
      "delimiters": [
        {"left": "$$", "right": "$$", "display": false}
      ]
    }
  }</script>
  </d-front-matter>

  <d-title>
    <p>An expedition across the magical and treacherous realm of data </p>

  </d-title>

  <d-byline></d-byline>


  <d-article>
      <a class="marker" href="#section-1" id="section1"><span>1: Data exploration</span></a>
      <a class="marker" href="#section-2" id="section2"><span>2: Data splits</span></a>
      <a class="marker" href="#section-3" id="section3"><span>3: Data shifts</span></a>
      <p> It was on a warm and breezy Friday afternoon that Luca, having indulged in a heavy lunch, found himself
          gazing at a determined squirrel
        that was perched on his window sill. The squirrel, clutching a stubborn nutshell with its tiny paws, executed an array of maneuvers with
        intense focus. It began by turning the nut around, testing its angles and seams, while steadily biting and gnawing with determination.
        Luca couldn't help draw a parallel to the time he had spent poring over lines of code, navigating the maze of his dataset with little success.
        Memories came rushing of the hours spent babysitting his model, in pursuit of a reasonable loss curve. Despite his best efforts,
        the model that had performed so well on the reported data inexplicably and repeatedly failed on his dataset. The model doesn't generalize,
          <i> it just doesn't generalize </i>. At that very moment, a gentle breeze swept in and comforted him. Gradually, he sensed his thoughts slowing down,
        his focus dwindling and his eyelids growing heavier...when an unexpected touch on his shoulder jolted him. </p>

      <q> <i> Come with me. Now. There's no time to explain </i> </q>
      <q> <i> Wh..What? </i> </q>


    <h3 id="section-1">Chapter 1: Explorers</h3>
      <a class="marker" href="#top" id="top1"><span>Top</span></a>
      <p> And so it was, that Luca now found himself in a strange and peculiar land. What he saw seemed both familiar and foreign to him, as he stared in disbelief
    at the boundless expanse that lay before him. Suddenly, Luca's thoughts turned to the unfinished work, his model
          that was probably training, the cluttered desk and the creaky chair that he
    left behind, all of which seemed like a world far far away from the one he was now standing in.
    He was overcome with confusion regarding the nature of his journey and the identity of the woman who had led
    him here. As if sensing his doubt, she proceeded to announce, 'Greetings to the land of DataRealm, where all data lives.
          Here, information flows like rivers and mountains of code rise into the sky.
          This is a realm of creation and discovery, where the human spirit and the digital domain converge to form a connected whole.' </p>

      <figure>
      <img src="assets/datarealm_2.png">
      <figcaption style="text-align: center;">Image generated by Sandy Engelhardt using <a
              href="https://www.midjourney.com/home/">Midjourney</a></figcaption>
      </figure>

      <p> As his eyes swept across the landscape, it slowly dawned upon him, as he faintly noticed gigantic crystalline structures in a distance that stood tall,
intricate with complex algorithms and databases. Interlinked nodes and circuits sprawled out like arteries, each a nexus of complex information, thoughts, and ideas.
          It was as if the whole world around him was drowning in the very essence of information and understanding. She continued,
          'Deep within the heart of this land lies the <i>Archive of Wisdom</i>,
a treasure of all what humanity has thus far learnt from data. I notice that you seem troubled by your journey. Worry
          not, I am going to guide you through it.' </p>

<p> His companion exuded a calming presence, one
    got the feeling she had seen countless travelers like him before and knew exactly how to comfort them.
    With a gentle grasp of his hand, she guided him towards a towering structure that loomed before them,
    pulsating with energy and emanating a soft, harmonious hum permeating the city behind it.
    Luca, initially puzzled, began to realize the significance of their journey.
    'To embark on this journey, you must first pass through these gates. These gates stand in memoriam to all the
    data that has been misused, neglected, tortured, and sacrificed to fit a narrative. Taking his hands and placing
    them gently upon the gates, she added 'Remember what they stand for, that you shall not repeat the same
    mistakes.' </p>

    <p> As Luca's hands met the gates, a vivid spectacle enveloped his senses. Swirling histograms and pair plots
        surrounded him, and he caught faint echoes of a voice, which might have been his companion's or something altogether different—he could not
        discern. 'Your journey is one of exploration,' the voice resonated. 'Before surrendering your data to a model, you shall embark on the quest to comprehend it.
        Delve into its distribution, and keep an eye out for glaring anomalies. Visualizing your data serves as a powerful tool for unearthing hidden insights.
        The <code> seaborn </code> Python library provides a wealth of such visualization resources, including
              <code> seaborn.histplot </code>, and <code> seaborn.pairplot </code>.
        And when the need arises, you shall visualize the features of your data, with principal component analysis or
        t-SNE visualizations <d-cite key="wattenberg_how_2016"></d-cite>.
        These methods not only aid in detecting outliers, but
        also unveil patterns in the data, helping you identify and select the most informative features."

            <aside>Is your data complete? Have you explored and visualised your data? Have you identified
    outliers? Is your data diversity, representative?</aside>
<!-- sample image of pair plot and feature distribution plot -->

      <p> "You shall strive to see if your data aligns with the fundamental assumptions that you made about your
          world. Be vigilant about potential spurious correlations in your dataset. Should such correlations arise,
          conduct a deeper examination to explore potential causal factors or hidden confounders that could underlie
          these observed effects." The voice then gradually faded, leaving Luca immersed in silence as he grappled with
          the unfolding of events. Luca found himself engulfed by anticipation and wonder, pondering whether this was a
          fleeting glimpse of the <i> Archive of Wisdom. </i> </p>

      <p> At that moment, Luca's companion broke the silence, inquiring, "Did you grasp the essence of the message?" Luca, still
          somewhat befuddled as he processed the information, struggled to formulate a response.
          Observing his confusion, she offered further clarity, "Allow me to provide you with a few examples." She began, "Consider,
          for instance, the research study that uncovered a noteworthy
          linear correlation (r=0.791, P<0.0001) <d-cite key="chocolate"></d-cite> between chocolate consumption and the number of Nobel
          laureates of a country. The chocolate intake per capita was found to be correlated with the cognitive function. However, a
          deeper look into the underlying factors influencing both the observed variables may be required, before coming to
          a conclusion that increased chocolate consumption <i> explains </i> an increased cognitive function.
          Similarly, take for example, a rule-based model <d-cite key="10.1145/2783258.2788613"></d-cite> that observed a history
          of asthma to be associated with a lower risk of pneumonia. Clearly this correlation is counterintuitive. In this case,
          a deeper look at the possible causal factors reveals that the asthmatic patients were directly admitted to the intensive care
    unit, and received better care, resulting in a now decreased risk of pneumonia compared to the rest of the population.
      Their discourse was abruptly interrupted by an intense cacophony, that sounded like the turning of metal cogs,
          prompting their attention to the gates that were gradually swinging open. </p>

      <aside>Does the data you are using for the task satisfy the assumptions of your model of
          the world? Are there possible confounders?</aside>

    <figure class="l-page">
      <img src="assets/nejmon1211064_f1.jpeg">
      <figcaption style="text-align: center;">Correlation between Countries' Annual Per Capita Chocolate Consumption and the Number of Nobel
        Laureates per 10 Million Population <d-cite key="chocolate"></d-cite>.</figcaption>
    </figure>

    <!--finally, remember, splitting your data can also end up introducing spurious correlations in your dataset. Remember the time when this work, which presented state-of-the-art performance that was better
than human radiologists in detecting pneumonia from chest X-rays <d-cite key="rajpurkar_chexnet_2017"></d-cite>. This
    work invited attention and critique regarding the data splits used <d-cite
            key="botz_few_2017,laurenoakdenrayner_chexnet_2018"></d-cite>. Now I am not questioning the validity
    of this
    work, but rather pointing your attention
to the importance of explicitly outlining your data splits in the pipeline to the extent possible. It is not trivial, as we will
see later in our journey. </p> -->

<h3 id="section-2">Chapter 2: A balancing act</h3>
      <a class="marker" href="#top" id="top2"><span>Top</span></a>
      <p> The two travellers embarked upon their journey into the heart of the realm, where the <i> Archive of wisdom </i> was said to reside.
          Luca's head buzzed with the newfound knowledge he had acquired. Meanwhile, his companion, her focus now shifted to their
      immediate surroundings, turned towards him with a sense of urgency. In an anxious tone, she explained, "Luca, we're about to enter
      the enchanted forests of the data realm, a crucial part of our journey. These forests are teeming with diverse creatures, some
      elusive, others freely roaming. While we're explorers here, we're not alone. Our task is to observe, learn, and understand this
      unique world, but navigating these dense woods requires assistance. The <i>guides</i> of this forest will help us learn and imbibe what
          these forests have to offer. Our goal is to finally meet the <i> guardians </i>, who sit at its center, guarding its ancient secrets.
          They remain unseen to our eye. Only when we've learned enough from the guides can we hope to meet the guardians and gain
          access to the coveted <i> Archive of wisdom </i>.

       <p>She paused, then continued with an analogy for Luca's better understanding, "Let me draw a parallel, Luca. Think of the
      training dataset as our exploration of the learning space, where we extract knowledge from our data. The performance on the
      validation set guides us in this process. Ultimately, we evaluate our model's performance on an entirely unseen test dataset.
      However, it's critical to assign roles wisely, akin to appointing explorers, guides, and guardians. Neglecting this could disrupt
      the entire ecosystem. You must ensure that these groups—equivalent to your train, validation, and test sets—are completely separate,
      with no knowledge of each other. In your context, this means avoiding data leakage; for instance, data from the same patient or
      frames from the same surgery should not be split across different sets.</p>

      <aside>Data splitting is non-trivial and may result in data leakage.</aside>

      <p> "But that's not all," she continued, emphasizing the importance of balance, "these creatures within our forest may
          come from various heights, some from the high canopies, others from the forest floor, and even some from beneath the
          earth. To maintain the harmony of this ecosystem, explorers, guides, and guardians must be proportionally represented,
          just as in the concept of stratification. You must have encountered the <code> sklearn </code> library, particularly the function
          <code> sklearn.model_selection.StratifiedShuffleSplit </code> <d-cite key="noauthor_sklearnmodel_selectionstratifiedshufflesplit_nodate"></d-cite>, right?
          Essentially, the distribution or the composition of the different
          classes or species within your folds must closely resemble that of your entire dataset. Moreover, if your data contains
          hierarchies, these too must be accurately mirrored within your distinct splits. </p>

      <aside>The shape of the class distributions in your split must reflect that in the source dataset.</aside>

      <figure class="l-page">
        <div style="display: flex">
          <div style="flex: 0 0 15%; display: flex; flex-direction: column; font-size: 10pt; gap: 10px; background-color: #f7f7f7; padding: 10px;">
      
            <div class="flex-row">
              Legend:
              <div class="flex-item" style="gap: 30px">
                <div id="class-legend" class="flex-row" style="gap: 2px; line-height: 13pt;"></div>
                <div id="group-legend" class="flex-row" style="line-height: 13pt;"></div>
              </div>
            </div>
      
            <div class="flex-row">
              Description:
              <div class="flex-item" style="gap: 30px">
                <div id="split-description" class="flex-row" style="font-size: 9pt; line-height: 11pt; text-justify: auto;">
                  The straightforward way to split a dataset is to take the first N samples for training and the remaining samples for testing.
                  However, this approach may introduce bias into the resulting dataset split, especially if the order of the samples entails relationships within the data.
                  Additionally, it may create sets that do not reflect the distribution of the source dataset or do not cover all classes.
                </div>
              </div>
            </div>
          </div>
      
          <div style="flex: 0 0 70%;">
            <svg id="stratification" width="100%"></svg>
          </div>
      
          <div id="controls" style="flex: 0 0 15%; display: flex; flex-direction: column; font-size: 10pt; gap: 10px; background-color: #f7f7f7; padding: 10px;">
      
            <div class="flex-row" style="gap: 5px">
              Dataset ordering:
              <div class="flex-item">
                <button class="button" id="class-sort-btn" style="flex: 1;">Class</button>
                <button class="button" id="group-sort-btn" style="flex: 1;">Group</button>
                <button class="button" id="shuffle-btn" style="flex: 1;">Shuffle</button>
              </div>
            </div>
      
            <div class="flex-row">
              <label>Ratio of training data: <span id="train-ratio">80</span>%</label>
              <input id="ratio-slider" class="slider" type="range" value="80" min="10" max="90" step="10" />
            </div>
      
            <div class="flex-row">
              <div class="flex-item">
                <legend>Split options:</legend>
              </div>
      
              <div class="flex-item">
                <input type="radio" id="index-split" value="index" name="option" checked>
                <label for="index-split">Index split</label>
              </div>
      
              <div class="flex-item">
                <input type="radio" id="shuffle-split" value="shuffle" name="option">
                <label for="shuffle-split">Shuffle split</label>
              </div>
      
              <div class="flex-item">
                <input type="radio" id="stratified-split" value="stratified" name="option">
                <label for="stratified-split">Stratified split</label>
              </div>
      
              <div class="flex-item">
                <input type="radio" id="group-split" value="group" name="option">
                <label for="group-split">Group split</label>
              </div>
      
            </div>
            <div class="flex-item">
              <button class="button" id="split-btn" style="flex: 3;">Split data</button>
              <button class="button" id="reset-btn" style="flex: 1;">Reset</button>
            </div>
          </div>
      
        </div>
        <figcaption style="text-align: center;">Interactive visualization of different dataset splitting techniques. Data is
          generated randomly on page reload.</figcaption>
      </figure>

      <p> I will give you a more concrete analogous use-case of <i>surgical workflow analysis</i>, something you may be familiar with.
          Here multiple aspects of a surgery come into the picture, such as surgical phases, and the transitions between them,
          the occurrence and co-occurrences of different surgical instruments, and the duration or difficulty of a surgery. Depending on
          the objectives of the task, there are different ways of splitting the data to reflect the source data
          distribution. Here, stratification can also be applied on multiple levels, such as to group the surgical
          phases as well as the surgical instruments. Here, visualisation tools such as
          <a href="https://cardio-ai.github.io/endovis-ml/" target="_blank">Endovis-ML</a> <d-cite
                  key="kostiuchik_surgical_2023"></d-cite> help in interactively exploring the
          splits of the data and ensuring no classes are unrepresented.
      </p>

      <aside>The <a href="https://cardio-ai.github.io/endovis-ml/" target="_blank">Endovis-ML</a> helps visualise data splits for surgical workflow analysis
        <a href="https://cardio-ai.github.io/endovis-ml/" target="_blank">
          <img width="250" src="assets/phase-view.PNG">
        </a>
      </aside>

<p> There is something else you should know about these enchanted forests. They are home to various creatures, but some species are
    rare and elusive, while others are abundant. Sometimes, the people seated in the archive of wisdom
    intentionally multiply the representation of the rarer species to maintain the harmony of the forests and allowing the minority to thrive.
    This is akin to the oversampling that you perform, where you artificially generate instances of the minority class of a dataset to make it more proportionate to the
    majority class. Sometimes we also banish some creatures that are rampant, to ensure balance. This would be similar to undersampling,
    where the number of instances from the majority class, are reduced, at times randomly, to create a balanced representation and minmize the bias.
    Take for example the case of detecting a rare diseases, from MRI images. The number of images that contain a tumor may be very limited, which may lead your model to
    be biased towards the majority class, in this case no tumour. This would eventually lead to a misleading evaluation,
    especially a lower sensitivity, and missed detections as a result. There are a multiple ways to
    oversample <d-cite key="reinke_common_2023"></d-cite> such as data augmentation, or using techniques like SMOTE (Synthetic minority
    over-sampling technique) <d-cite key="chawla_smote_2002"></d-cite> which creates new synthetic instances by interpolating between existing minority class instances.</p>

      <aside>Oversampling and undersampling are two techniques to deal with data imbalance and rare cases.</aside>

<h3 id="section-3">Chapter 3: Shifting realities</h3>
<a class="marker" href="#top" id="top3"><span>Top</span></a>
<p> Luca's journey had been long and winding, and fatigue was beginning to wear him down. Yet, he remained resolute,
    determined to see it through to its conclusion. His confusion had given way to gratitude and deep appreciation for
    the wealth of knowledge he was gaining. Life often introduces unexpected benefactors who profoundly
    change one's life for the better, and Luca had come to realize that his companion was one such benefactor. Together, they had left
    the enchanted forests behind and now ventured into the valleys, drawing closer to their ultimate destination.
    As Luca took his first step into the valley, he felt the ground beneath him shifting. He turned to his companion in astonishment,
    and she promptly offered an explanation, "We are now in the final leg of our journey, but be warned, this is no ordinary valley.
    Here, everything is in a constant state of flux, with these terrains continually shifting. I have a map that will guide you to the
    Archive of Wisdom, but you'll notice that everything is constantly moving on it. Creating and maintaining such a map is not an
    extraordinary feat." To illustrate her point, she continued with an analogy, "Let me provide you with an example. No matter how
    diligently you train your model on a dataset, its performance may decline over time due to data shifts. Just as these terrains
    keep moving, data can change in unpredictable ways. It's a challenge we must be prepared for on our journey."</p>

      <aside>Model performance tends to degrade over time due to the temporal nature of data and model shifts.</aside>

<p> For example, assume you have the task of predicting
tumor volume from features learnt from CT scans <d-cite key="dockes_preventing_2021"></d-cite>. The size of the tumor (X) is not only influenced by the image features (Y) but also a contrast agent (M).
Here, selecting images of high resolution, or selecting images that have a particular strength of contrast agent, both introduce bias in selecting
the data. The tumor volume learnt as a result is from a subset of the data that was had certain biases in the sampling, and now when the model
encounters data from the wild, it has trouble to adapt to this shift in the distribution. One way to tackles this problem is by _importance weighting_.
This means weighting your data as per the importance expected to be observed in the target distribution. For instance, the attributes that are rarely seen
observed in the source dataset but are more likely to be seen in the target dataset are assigned more importance. Another approach is to use
uncertainty estimation to make the model robust to shifts that are expected to be observed.
Keep in mind that it is not just data, but new relationships can evolve over time from your data. This is called _concept shift_.
Take for example, a model that predicts patient mortality based on pneumonia <d-cite key="huang_developing_2022"></d-cite>. The arrival of Covid-19 introduced a novel class as compared to bacterial
pneumonia. Often a combination of both shifts may be observed in the real world. In the same example for instance, a model trained on
    pre-covid vaccination data may overestimate risk for a vaccinated population. </p>

      <aside>Data shifts occur when the joint distribution or prevalence of the data changes while the relationship
          between the input and output variables remains the same.</aside>

          <figure>
      <img src="assets/giab055fig3.jpg">
      <figcaption style="text-align: center;">Sample selection bias: three examples. On the right are graphs giving conditional independence relations <d-cite key="pearl_causal_2016"></d-cite>.
          Y is the lesion volume to be predicted (i.e., the output). M are the imaging parameters, e.g., contrast agent dosage. X is the image,
          and depends both on Y and M (in this toy example X is computed as X:= Y+M, where ϵ is additive noise). S
          indicates that data are selected
          to enter the source dataset (orange points) or not (blue points). The symbol equation ⊥⊥ means independence between variables.
          Preferentially selecting samples results in a dataset shift (middle and bottom row). Depending on whether
          equation Y⊥⊥S|X,
          the conditional distribution of Y|X—here lesion volume given the image—estimated on the selected data may be
          biased or not. <d-cite key="dockes_preventing_2021"></d-cite></figcaption>
      </figure>

<p> After his long and winding journey, Luca now stood in the heart of the realm. He was at the precipice of the hallowed archive of wisdom,
waiting with a sense of anticipation in every breath.
Yet, when he glanced behind, his faithful companion, who had been his guide, had vanished, leaving him with a trail of memories and the
knowledge shared. It was as if her purpose had been fulfilled, and her absence was now a testament to where Luca was in his journey.
As his foot touched the ground, a sudden disorientation swept over him, as he stumbled backward with a loud thud.
The world around him flickered and dimmed. When his eyes blinked open, he found himself sprawled on the floor of his office,
seemingly fallen from his office chair. The shifting visions of the DataRealm had vanished, giving way to the familiar sights of his
cluttered desk. His model had now finished training.
With a thoughtful grin, Luca outside to find his old friend, the squirrel, still perched on the window sill.
    Having cracked open the shell, he was now savouring the treasures of his labour with a glint in his eye. </p>

      <figure>
      <img src="assets/squirrel.png">
      <figcaption style="text-align: center;">Image generated by Sandy Engelhardt using <a href="https://www.midjourney.com/home/">Midjourney</a></figcaption>
    </figure>

      <aside>This is the sign you were looking for :)</aside>

  </d-article>

  <d-appendix>
    <h3>Note</h3>
      <p>This article is a submission to the MICCAI Educational Challenge 2023</p>
      <h3>Acknowledgements</h3>
      <p>The authors would like to acknowledge the contributions of Lorenz Quack, Halvar Kelm, and Dale Chrislene
          for their valuable inputs and suggestions.</p>

    <d-bibliography src="bibliography.bib"></d-bibliography>
  </d-appendix>

  <distill-footer></distill-footer>
  <script src="stratification.js" type="module"></script>

</body>
